<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="layout.html">
<div layout:fragment="content">
    <h2 class="text-center text-secondary">
        All users, you can change they permissions
    </h2>
    <div class="row">
        <div class="col-8 mx-auto">
            <table class="table">
                <thead>
                <tr>
                    <th scope="col">Id</th>
                    <th scope="col">Full Name</th>
                    <th scope="col">Email</th>
                    <th scope="col">Permissions</th>
                    <th scope="col">Add permission</th>
                    <th scope="col">Delete permission</th>
                </tr>
                </thead>
                <tbody id="users_table">
                </tbody>
            </table>
        </div>
        <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="addModalLabel">Modal title</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-6 mx-auto">
                                <div class="row">
                                    <div class="col-12">
                                        <label>Add Permission : </label>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12 form-control">
                                        <select id="add_select" class="form-control">

                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="deleteModalLabel">Modal title</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-6 mx-auto">
                                <div class="row">
                                    <div class="col-12">
                                        <label>Delete Permission : </label>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12 form-control">
                                        <select id="delete" class="form-control">

                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
        <script type="text/javascript">

            loadUsers();

            function loadUsers() {
                const httpRequest = new XMLHttpRequest();
                httpRequest.open("GET", "http://localhost:8000/getAllUsers", true);
                httpRequest.onreadystatechange = function () {
                    if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200) {
                        let userList = JSON.parse(httpRequest.responseText);
                        let tableContent = "";
                        let variable = 0;
                        for (let i = 0; i < userList.length; i++) {
                            tableContent += "<tr>";
                            tableContent += "<th scope=\"row\">" + userList[i].id + "</th>";
                            tableContent += "<td>" + userList[i].fullName + "</td>";
                            tableContent += "<td>" + userList[i].email + "</td>";
                            tableContent += "<td>";
                            tableContent += "<section class=\"btn-group\">";
                            for (let j = 0; j < userList[i].permissions.length; j++) {
                                tableContent += "<input type=\"checkbox\" \n" +
                                    "               class=\"btn-check btn-sm\" \n" +
                                    "               id=\"gfg" + userList[i].permissions[j].id + "\">";
                                tableContent += "<label class=\"btn btn-outline-success btn-sm\" \n" +
                                    "               for=\"gfg" + userList[i].permissions[j].id + "\">\n" +
                                    "               " + userList[i].permissions[j].role + "\n" +
                                    "        </label>";
                            }
                            tableContent += "</section>";
                            tableContent += "</td>";
                            tableContent += "<td><button type=\"button\" class=\"btn btn-success btn-sm\"" +
                                " " +
                                " onclick='openCourseDetailsModal("+userList[i].id+")'>" +
                                "Add permission" +
                                "</button></td>";
                            tableContent += "<td><button type=\"button\" class=\"btn btn-secondary btn-sm\"" +
                                "data-bs-toggle=\"modal\" data-bs-target=\"#deleteModal\"" +
                                " onclick='loadPermissions()'>" +
                                "Delete Permission" +
                                "</button></td>"
                        }
                        document.getElementById("users_table").innerHTML = tableContent;
                    }
                }
                httpRequest.send();
            }

            function openCourseDetailsModal(id){

                detailsModal = new bootstrap.Modal(document.getElementById('addModal'));

                const httpRequest = new XMLHttpRequest();
                httpRequest.open("GET", "http://localhost:8000/getAllPermissions", true);
                httpRequest.onreadystatechange = function () {
                    if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200) {
                        let permissionList = JSON.parse(httpRequest.responseText);
                        let permissionContent = "";
                        for (let i = 0; i < permissionList.length; i++) {
                            permissionContent += "<option value='"+permissionList[i].id+"' class='form-control'>"+permissionList[i].role+"</option>"
                        }
                        document.getElementById("add_select").innerHTML = permissionContent;
                        detailsModal.show();
                    }
                }
                httpRequest.send();

            }
            function loadPermissions(){
                const httpRequest = new XMLHttpRequest();
                httpRequest.open("GET", "http://localhost:8000/getAllPermissions", true);
                httpRequest.onreadystatechange = function () {
                    if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200) {
                        let permissionList = JSON.parse(httpRequest.responseText);
                        let permissionContent = "";
                        for (let i = 0; i < permissionList.length; i++) {
                            permissionContent += "<option value='"+permissionList[i].id+"' class='form-control'>"+permissionList[i].role+"</option>"
                        }
                        document.getElementById("delete").innerHTML = permissionContent;
                    }
                }
                httpRequest.send();
            }

            function assignPermission(userId){
                const httpRequest = new XMLHttpRequest();
                httpRequest.open("POST", "http://localhost:8000/assignPermission", true);
                httpRequest.setRequestHeader("Content-Type", "application/json");
                let assignPermission = document.getElementById("add_select");
                httpRequest.onreadystatechange = function () {
                    if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200) {
                        window.location.reload();
                    }
                };
                let body = {
                    'user_id': userPerId.value,
                    'permission_id': assignPermission.value
                };
                body = JSON.stringify(body);
                httpRequest.send(body);
            }

            function deletePermission(userId){
                const httpRequest = new XMLHttpRequest();
                httpRequest.open("POST", "http://localhost:8000/un_assignPermission", true);
                httpRequest.setRequestHeader("Content-Type", "application/json");
                let assignPermission = document.getElementById("add_select");
                httpRequest.onreadystatechange = function () {
                    if (httpRequest.readyState == XMLHttpRequest.DONE && httpRequest.status == 200) {
                        window.location.reload();
                    }
                };
                let body = {
                    'user_id': userPerId.value,
                    'permission_id': assignPermission.value
                };
                body = JSON.stringify(body);
                httpRequest.send(body);
            }
        </script>
    </div>
</div>
</html>